🚀 K-LMS Auto Checker (Standalone)
Go言語 × Playwright × Gemini × LINE/Gmail 慶應義塾大学の K-LMS（Canvas）をバックグラウンドで高速監視し、課題が追加された瞬間に LINEとメールで通知 する自動化ツールです。

> **Note**: Gemini APIのrate limit制限（2024年12月7日頃の変更: 1日20回）を考慮した実装となっています。

✨ 特徴
完全自立型: GAS（Google Apps Script）や中間サーバーは不要。PC単体で完結します。

爆速: 起動からチェック終了までわずか数秒。

ステルス: 作業の邪魔をしない完全バックグラウンド実行。

W通知: LINEで「速報」を、Gmailで「詳細（スクショ付き）」を受け取れます。

📅 課題を Googleカレンダーに自動取り込み

K-LMS 上の「課題の締切情報」をもとに、プログラム実行時に `schedule.ics` というカレンダーファイルを自動生成します。

- 課題のタイトル・締切日時などを内部で JSON 形式にまとめ、それを元に iCalendar 形式 (`.ics`) のファイルを生成
- **新規課題のみ**が.icsファイルに含まれます（重複防止機能により、既に通知済みの課題は除外されます）
- 生成された `schedule.ics` は Gmail 通知メールに添付されます
- スマホでメールを開き、`schedule.ics` をダウンロードして開くと、そのまま Googleカレンダーに予定として追加できます

※ `schedule.ics` は新規課題がある場合のみ生成されるファイルであり、リポジトリには含めていません（`.gitignore` 対象）。
※ 送信履歴は `data/sent_history.json` に保存され、同じ課題（科目名・課題名・期限が同じ）は重複通知されません。

📦 配布内容
フォルダ内には以下のファイルのみが含まれています。

K-LMS-Mac (または K-LMS.exe) ... アプリ本体

.env ... 設定ファイル

README.md ... この説明書

⚙️ 設定ファイルの準備 (.env)
同梱されている .env ファイルをテキストエディタで開き、以下の情報を入力して保存してください。

Ini, TOML

# --- 1. 大学ログイン情報 ---
KEIO_USER=your_id@keio.jp
KEIO_PASS=your_password

# --- 2. AI設定 (OCR用) ---
# Google AI Studioで無料取得: https://aistudio.google.com/app/apikey
GEMINI_API_KEY=取得したキーを貼り付け

# --- 3. LINE通知設定 (Messaging API) ---
# LINE Developersで取得したトークンとUser ID
LINE_TOKEN=
LINE_USER_ID=

# --- 4. Gmail通知設定 (画像送付用) ---
# 自分のGmailアドレス
SMTP_USER=your_email@gmail.com
# Gmailの「アプリパスワード」(16桁) ※普段のログインパスワードではありません
SMTP_PASS=xxxx xxxx xxxx xxxx
💡 Gmailアプリパスワードの取得方法

Googleアカウント管理 → セキュリティ → 2段階認証をオン

セキュリティ画面の検索窓で「アプリパスワード」と検索

適当な名前（K-LMSなど）をつけて作成 → 生成された16桁を使用

🪟 Windowsでのセットアップ手順

1. `.env` を設定します（上記の設定ファイルの準備を参照）

2. `K-LMS.exe` をダブルクリックして動作確認します（初回は数秒かかります）

3. **タスクスケジューラ** に登録します
   - トリガー: 毎日 (詳細設定で「1分間隔」「継続時間: 9時間」など)
   - 操作: プログラムの開始 (`K-LMS.exe`を選択)
   - 開始オプション (重要): `K-LMS.exe` があるフォルダのパスを入力
   - 条件: 「タスクを実行するためにスリープを解除する」にチェック

📝 実行方法

### ターミナルから実行
```powershell
# プロジェクトディレクトリに移動
cd C:\Users\hayam\K-LMS-Go

# 直接実行
go run main.go

# または、ビルドしてから実行
go build -o K-LMS.exe
.\K-LMS.exe
```

### ログの確認
実行中はログが `logs\run-log.txt` に出力されます。
```powershell
# ログをリアルタイムで確認
Get-Content logs\run-log.txt -Wait -Tail 50
```

💡 主な機能・改善点

### 🔄 自動リトライ機能
- タイムアウトエラーが発生した場合、最大3回まで自動的にリトライします
- リトライ間隔は5秒で、K-LMSの応答が遅い場合でも確実に処理を完了します

### 🎯 複数セレクタのフォールバック処理
- ダッシュボードの読み込み時に、複数のセレクタを順番に試行します
- いずれかのセレクタが見つかれば処理を続行するため、K-LMSの表示形式が変わっても対応可能です

### 💾 画像キャッシュ機能
- 同じ画像（ハッシュが同じ）の場合は、OCR結果をキャッシュから取得します
- これにより、Gemini APIの使用回数を大幅に削減できます
- **Gemini APIのrate limit制限（1日20回）に対応**するため、キャッシュ機能を実装しています

### 📊 使用回数表示
- ログにGemini APIの使用回数（残り回数）が表示されます
- 制限到達時には警告メッセージを表示します

### 🛡️ エラーハンドリング改善
- OCRエラー時でも画像を添付して通知を送信します
- タイムアウトエラーは致命的なエラーとして扱わず、次回実行時に再試行します
- タイムアウト時のデバッグ情報（スクリーンショット・HTML）を自動保存します

### ⚙️ 設定の外部化とバリデーション
- 設定のバリデーション機能を追加しました
- 必須項目が不足している場合は起動時にエラーを表示します

### 🔁 重複防止機能
- 同じ課題の.icsファイルを重複生成しないように、送信履歴を管理します
- `data/sent_history.json`に送信済み課題のIDを保存し、新規課題のみを通知します

⚠️ 注意事項

### セキュリティ
- `.env`の管理: パスワードが含まれるため、このファイルは絶対に他人に渡さないでください
- ログファイル: ログファイルには機密情報が含まれる可能性があるため、適切に管理してください

### API制限
- **Gemini APIの無料枠は1日20回に制限されています**（2024年12月7日頃のrate limit変更を考慮済み）
- 同じ画像の場合は自動的にキャッシュから結果を取得するため、実質的な使用回数は大幅に削減されます
- 環境変数 `MAX_GEMINI_PER_DAY` を設定することで、1日あたりの使用制限を変更できます（デフォルト: 20回）
- 画像キャッシュ機能により、同じ画像の再OCRを回避し、API使用回数を効率的に管理します

### タイムアウトエラーについて
- K-LMSの応答が遅い場合、タイムアウトエラーが発生することがあります
- 自動リトライ機能により、多くの場合で自動的に解決されます
- タイムアウトエラーの通知は1時間に1回までに制限されています（通知過多を防止）

### データファイル
- `data/sent_history.json`: 送信済み課題の履歴（削除すると全課題が新規として扱われます）
- `data/ocr-cache.json`: OCR結果のキャッシュ（削除するとキャッシュがリセットされます）
- `data/daily-gemini-count.json`: Gemini APIの使用回数記録（日次でリセットされます）
- `logs/timeout-debug-*.png`, `logs/timeout-debug-*.html`: タイムアウト時のデバッグ情報

責任者：慶應義塾大学商学部2年 宮久保隼(haya.miy02@keio.jp)